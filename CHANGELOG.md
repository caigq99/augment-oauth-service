# 更新日志

本文档记录了 Augment OAuth Service 的所有重要更改。

格式基于 [Keep a Changelog](https://keepachangelog.com/zh-CN/1.0.0/)，
并且本项目遵循 [语义化版本](https://semver.org/lang/zh-CN/)。

## [未发布]

### 新增
- 智能端口管理功能
  - 自动检测端口占用情况
  - 端口被占用时自动查找可用端口
  - 支持端口范围扫描（默认扫描100个端口）
- 灵活的配置管理系统
  - 支持环境变量配置
  - 支持 .env 文件配置
  - 支持系统配置文件
  - 配置优先级管理
- 新增配置模块 (`src/config.rs`)
  - `AppConfig` 结构体统一管理配置
  - `is_port_available()` 函数检测端口可用性
  - `find_available_port()` 函数查找可用端口
  - `get_available_server_addr()` 函数获取可用服务器地址
- 详细的启动日志
  - 显示配置信息
  - 端口检测状态
  - 服务地址信息
- 完善的文档系统
  - API 文档 (`docs/API.md`)
  - 配置指南 (`docs/CONFIGURATION.md`)
  - 部署指南 (`docs/DEPLOYMENT.md`)
  - 开发指南 (`docs/DEVELOPMENT.md`)

### 改进
- 优化错误处理，避免端口占用导致的 panic
- 增强日志输出，提供更详细的运行状态信息
- 改进代码结构，增加模块化设计
- 更新技术栈文档，包含新增依赖项

### 依赖更新
- 新增 `dotenvy = "0.15"` - .env 文件支持
- 新增 `config = "0.14"` - 配置文件管理

### 技术改进
- 使用 `TcpListener` 进行端口可用性检测
- 实现配置优先级系统
- 添加配置验证和错误处理
- 优化服务启动流程

## [0.1.0] - 2025-01-01

### 新增
- 初始版本发布
- OAuth 2.0 PKCE 流程实现
- RESTful API 接口
  - `GET /health` - 健康检查
  - `GET /api/auth-url` - 获取授权链接
  - `POST /api/complete-auth` - 完成授权
- 统一的 JSON 响应格式
- 安全的状态管理
  - 内存存储 OAuth 状态
  - 30分钟自动过期
  - CSRF 防护
- 高性能异步处理
- CORS 支持
- 结构化日志记录
- 跨平台支持
  - Linux (x86_64, ARM64)
  - macOS (x86_64, ARM64)
  - Windows (x86_64)

### 技术栈
- **Axum**: Web 框架
- **Tokio**: 异步运行时
- **Serde**: 序列化/反序列化
- **Reqwest**: HTTP 客户端
- **DashMap**: 并发安全的 HashMap
- **UUID**: 唯一标识符生成
- **SHA2**: 加密哈希
- **Base64**: 编码/解码
- **Tracing**: 日志记录

### 安全特性
- PKCE 流程防止授权码拦截攻击
- State 验证防止 CSRF 攻击
- 状态过期机制
- 内存存储确保数据安全

### 部署支持
- 一键安装脚本
- systemd 服务支持 (Linux)
- launchd 服务支持 (macOS)
- Docker 容器化支持
- 反向代理配置示例

---

## 版本说明

### 语义化版本格式

版本号格式：`主版本号.次版本号.修订号`

- **主版本号**: 不兼容的 API 修改
- **次版本号**: 向下兼容的功能性新增
- **修订号**: 向下兼容的问题修正

### 更改类型

- **新增**: 新功能
- **改进**: 对现有功能的改进
- **修复**: 问题修复
- **移除**: 移除的功能
- **安全**: 安全相关的修复
- **废弃**: 即将移除的功能

### 发布周期

- **主版本**: 根据需要发布，包含重大更改
- **次版本**: 每月发布，包含新功能和改进
- **修订版**: 根据需要发布，主要是问题修复

### 支持政策

- **当前版本**: 完全支持，包含新功能和安全更新
- **前一个主版本**: 安全更新和重要问题修复
- **更早版本**: 不再维护，建议升级

### 升级指南

#### 从 0.1.0 升级到最新版本

1. **备份配置**: 保存当前的环境变量配置
2. **停止服务**: 停止当前运行的服务
3. **更新二进制文件**: 下载最新版本
4. **迁移配置**: 
   - 环境变量配置无需更改
   - 可选择使用新的 .env 文件配置
5. **启动服务**: 启动新版本服务
6. **验证功能**: 测试 API 端点确保正常工作

#### 配置迁移

**旧版本 (环境变量)**:
```bash
export PORT=3000
export HOST=0.0.0.0
export RUST_LOG=info
```

**新版本 (支持多种方式)**:
```bash
# 方式1: 继续使用环境变量 (无需更改)
export PORT=3000
export HOST=0.0.0.0
export RUST_LOG=info

# 方式2: 使用 .env 文件
echo "PORT=3000" > .env
echo "HOST=0.0.0.0" >> .env
echo "RUST_LOG=info" >> .env

# 方式3: 使用系统配置文件 (自动创建)
# /etc/augment-oauth/config.env
```

### 兼容性

- **API 兼容性**: 所有 API 端点保持向下兼容
- **配置兼容性**: 现有环境变量配置继续有效
- **数据兼容性**: OAuth 状态格式保持不变

### 已知问题

- 服务重启后内存中的 OAuth 状态会丢失
- 高并发情况下端口扫描可能较慢
- Windows 系统下的端口检测可能不够准确

### 计划功能

- 持久化状态存储选项
- 配置热重载
- 更多的监控指标
- 集群部署支持
- 更多的认证提供商支持
