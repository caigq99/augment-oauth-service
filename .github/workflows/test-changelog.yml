name: 测试 Changelog 生成

on:
  workflow_dispatch:
    inputs:
      test_type:
        description: '测试类型'
        required: true
        type: choice
        options:
          - 'full'
          - 'unreleased'
          - 'config-test'
        default: 'config-test'

jobs:
  test-changelog:
    name: 测试 Changelog
    runs-on: ubuntu-latest
    permissions:
      contents: read

    steps:
      - name: 检出代码
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: 安装 git-cliff
        uses: taiki-e/install-action@v2
        with:
          tool: git-cliff

      - name: 验证配置文件
        run: |
          echo "🔍 验证 cliff.toml 配置文件..."
          
          if [ ! -f cliff.toml ]; then
            echo "❌ cliff.toml 文件不存在"
            exit 1
          fi
          
          echo "✅ cliff.toml 文件存在"
          
          # 验证配置语法
          echo "🔧 验证配置语法..."
          git-cliff --config cliff.toml --dry-run || {
            echo "❌ 配置文件语法错误"
            exit 1
          }
          
          echo "✅ 配置文件语法正确"

      - name: 测试 git-cliff 命令
        run: |
          echo "🧪 测试 git-cliff 命令..."
          
          case "${{ github.event.inputs.test_type }}" in
            "full")
              echo "📋 测试完整 changelog 生成"
              git-cliff --output test-changelog.md
              ;;
            "unreleased")
              echo "📝 测试未发布更改生成"
              git-cliff --unreleased --output test-changelog.md
              ;;
            "config-test")
              echo "⚙️ 测试配置文件"
              git-cliff --config cliff.toml --dry-run --verbose
              ;;
          esac

      - name: 检查生成结果
        if: github.event.inputs.test_type != 'config-test'
        run: |
          echo "📊 检查生成结果..."
          
          if [ -f test-changelog.md ]; then
            echo "✅ Changelog 生成成功"
            
            FILE_SIZE=$(stat -c%s test-changelog.md)
            LINE_COUNT=$(wc -l < test-changelog.md)
            
            echo "📊 文件大小: $FILE_SIZE 字节"
            echo "📏 总行数: $LINE_COUNT 行"
            
            echo "📄 前 20 行内容:"
            head -20 test-changelog.md
          else
            echo "❌ Changelog 生成失败"
            exit 1
          fi

      - name: 输出测试摘要
        run: |
          echo "## 🧪 Changelog 测试摘要" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "✅ **状态**: 测试完成" >> $GITHUB_STEP_SUMMARY
          echo "🔧 **测试类型**: ${{ github.event.inputs.test_type }}" >> $GITHUB_STEP_SUMMARY
          echo "🛠️ **工具**: git-cliff" >> $GITHUB_STEP_SUMMARY
          echo "⚙️ **配置**: cliff.toml" >> $GITHUB_STEP_SUMMARY
