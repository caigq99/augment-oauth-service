name: æµ‹è¯• Changelog ç”Ÿæˆ

on:
  workflow_dispatch:
    inputs:
      test_type:
        description: 'æµ‹è¯•ç±»å‹'
        required: true
        type: choice
        options:
          - 'full'
          - 'unreleased'
          - 'config-test'
        default: 'config-test'

jobs:
  test-changelog:
    name: æµ‹è¯• Changelog
    runs-on: ubuntu-latest
    permissions:
      contents: read

    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: å®‰è£… git-cliff
        uses: taiki-e/install-action@v2
        with:
          tool: git-cliff

      - name: éªŒè¯é…ç½®æ–‡ä»¶
        run: |
          echo "ğŸ” éªŒè¯ cliff.toml é…ç½®æ–‡ä»¶..."
          
          if [ ! -f cliff.toml ]; then
            echo "âŒ cliff.toml æ–‡ä»¶ä¸å­˜åœ¨"
            exit 1
          fi
          
          echo "âœ… cliff.toml æ–‡ä»¶å­˜åœ¨"
          
          # éªŒè¯é…ç½®è¯­æ³•
          echo "ğŸ”§ éªŒè¯é…ç½®è¯­æ³•..."
          git-cliff --config cliff.toml --dry-run || {
            echo "âŒ é…ç½®æ–‡ä»¶è¯­æ³•é”™è¯¯"
            exit 1
          }
          
          echo "âœ… é…ç½®æ–‡ä»¶è¯­æ³•æ­£ç¡®"

      - name: æµ‹è¯• git-cliff å‘½ä»¤
        run: |
          echo "ğŸ§ª æµ‹è¯• git-cliff å‘½ä»¤..."
          
          case "${{ github.event.inputs.test_type }}" in
            "full")
              echo "ğŸ“‹ æµ‹è¯•å®Œæ•´ changelog ç”Ÿæˆ"
              git-cliff --output test-changelog.md
              ;;
            "unreleased")
              echo "ğŸ“ æµ‹è¯•æœªå‘å¸ƒæ›´æ”¹ç”Ÿæˆ"
              git-cliff --unreleased --output test-changelog.md
              ;;
            "config-test")
              echo "âš™ï¸ æµ‹è¯•é…ç½®æ–‡ä»¶"
              git-cliff --config cliff.toml --dry-run --verbose
              ;;
          esac

      - name: æ£€æŸ¥ç”Ÿæˆç»“æœ
        if: github.event.inputs.test_type != 'config-test'
        run: |
          echo "ğŸ“Š æ£€æŸ¥ç”Ÿæˆç»“æœ..."
          
          if [ -f test-changelog.md ]; then
            echo "âœ… Changelog ç”ŸæˆæˆåŠŸ"
            
            FILE_SIZE=$(stat -c%s test-changelog.md)
            LINE_COUNT=$(wc -l < test-changelog.md)
            
            echo "ğŸ“Š æ–‡ä»¶å¤§å°: $FILE_SIZE å­—èŠ‚"
            echo "ğŸ“ æ€»è¡Œæ•°: $LINE_COUNT è¡Œ"
            
            echo "ğŸ“„ å‰ 20 è¡Œå†…å®¹:"
            head -20 test-changelog.md
          else
            echo "âŒ Changelog ç”Ÿæˆå¤±è´¥"
            exit 1
          fi

      - name: è¾“å‡ºæµ‹è¯•æ‘˜è¦
        run: |
          echo "## ğŸ§ª Changelog æµ‹è¯•æ‘˜è¦" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "âœ… **çŠ¶æ€**: æµ‹è¯•å®Œæˆ" >> $GITHUB_STEP_SUMMARY
          echo "ğŸ”§ **æµ‹è¯•ç±»å‹**: ${{ github.event.inputs.test_type }}" >> $GITHUB_STEP_SUMMARY
          echo "ğŸ› ï¸ **å·¥å…·**: git-cliff" >> $GITHUB_STEP_SUMMARY
          echo "âš™ï¸ **é…ç½®**: cliff.toml" >> $GITHUB_STEP_SUMMARY
