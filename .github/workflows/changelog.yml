name: Ëá™Âä®ÁîüÊàê Changelog

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:
    inputs:
      tag:
        description: 'ÊåáÂÆöÊ†áÁ≠æ (ÂèØÈÄâ)'
        required: false
        type: string
      unreleased:
        description: 'ÁîüÊàêÊú™ÂèëÂ∏ÉÁöÑÊõ¥Êîπ'
        required: false
        type: boolean
        default: false

jobs:
  generate-changelog:
    name: ÁîüÊàê Changelog
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write

    steps:
      - name: Ê£ÄÂá∫‰ª£Á†Å
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: ÂÆâË£Ö git-cliff
        uses: taiki-e/install-action@v2
        with:
          tool: git-cliff

      - name: ÁîüÊàê Changelog
        id: changelog
        run: |
          echo "üîÑ ÁîüÊàê Changelog..."
          
          # Ê†πÊçÆËæìÂÖ•ÂèÇÊï∞ÊûÑÂª∫ÂëΩ‰ª§
          CLIFF_ARGS="--output CHANGELOG.md"
          
          if [ "${{ github.event.inputs.unreleased }}" = "true" ]; then
            CLIFF_ARGS="$CLIFF_ARGS --unreleased"
            echo "üìù ÁîüÊàêÊú™ÂèëÂ∏ÉÁöÑÊõ¥Êîπ"
          fi
          
          if [ -n "${{ github.event.inputs.tag }}" ]; then
            CLIFF_ARGS="$CLIFF_ARGS --tag ${{ github.event.inputs.tag }}"
            echo "üè∑Ô∏è ÁîüÊàêÂà∞Ê†áÁ≠æ: ${{ github.event.inputs.tag }}"
          fi
          
          # ÊâßË°å git-cliff
          git-cliff $CLIFF_ARGS
          
          # Ê£ÄÊü•ÊòØÂê¶ÊúâÊõ¥Êîπ
          if git diff --quiet CHANGELOG.md; then
            echo "üìÑ Changelog Ê≤°ÊúâÊõ¥Êîπ"
            echo "changed=false" >> $GITHUB_OUTPUT
          else
            echo "‚úÖ Changelog Â∑≤Êõ¥Êñ∞"
            echo "changed=true" >> $GITHUB_OUTPUT
            
            # Ëé∑ÂèñÊñá‰ª∂‰ø°ÊÅØ
            FILE_SIZE=$(stat -c%s CHANGELOG.md)
            LINE_COUNT=$(wc -l < CHANGELOG.md)
            echo "üìä Êñá‰ª∂Â§ßÂ∞è: $FILE_SIZE Â≠óËäÇ"
            echo "üìè ÊÄªË°åÊï∞: $LINE_COUNT Ë°å"
          fi

      - name: Êèê‰∫§ Changelog
        if: steps.changelog.outputs.changed == 'true'
        run: |
          echo "üìù Êèê‰∫§ Changelog Êõ¥Êîπ..."
          
          # ÈÖçÁΩÆ Git
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          
          # Êèê‰∫§Êõ¥Êîπ
          git add CHANGELOG.md
          git commit -m "docs: Ëá™Âä®Êõ¥Êñ∞ Changelog
          
          - ÈÄöËøá GitHub Actions Ëá™Âä®ÁîüÊàê
          - Âü∫‰∫é git-cliff Â∑•ÂÖ∑
          - ÂåÖÂê´ÊúÄÊñ∞ÁöÑÊèê‰∫§ÂéÜÂè≤"
          
          # Êé®ÈÄÅÊõ¥Êîπ
          git push origin HEAD:main

      - name: ÂàõÂª∫ Pull Request (ÂèØÈÄâ)
        if: steps.changelog.outputs.changed == 'true' && github.event_name == 'workflow_dispatch'
        uses: peter-evans/create-pull-request@v5
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: "docs: Ëá™Âä®Êõ¥Êñ∞ Changelog"
          title: "üìù Ëá™Âä®Êõ¥Êñ∞ Changelog"
          body: |
            ## üìã Ëá™Âä®ÁîüÊàêÁöÑ Changelog Êõ¥Êñ∞
            
            Ëøô‰∏™ PR ÂåÖÂê´‰∫ÜËá™Âä®ÁîüÊàêÁöÑ Changelog Êõ¥Êñ∞„ÄÇ
            
            ### üîÑ Êõ¥ÊîπÂÜÖÂÆπ
            - Âü∫‰∫éÊúÄÊñ∞ÁöÑ Git Êèê‰∫§ÂéÜÂè≤ÁîüÊàê
            - ‰ΩøÁî® git-cliff Â∑•ÂÖ∑Ëá™Âä®Ê†ºÂºèÂåñ
            - ÈÅµÂæ™ Keep a Changelog Ê†ºÂºèËßÑËåÉ
            
            ### ü§ñ Ëá™Âä®Âåñ‰ø°ÊÅØ
            - **Ëß¶ÂèëÊñπÂºè**: ${{ github.event_name }}
            - **Â∑•‰ΩúÊµÅ**: ${{ github.workflow }}
            - **ËøêË°åID**: ${{ github.run_id }}
            
            ËØ∑Ê£ÄÊü•ÁîüÊàêÁöÑÂÜÖÂÆπÊòØÂê¶Ê≠£Á°ÆÔºåÁÑ∂ÂêéÂêàÂπ∂Ê≠§ PR„ÄÇ
          branch: changelog-update
          delete-branch: true

      - name: ËæìÂá∫ÊëòË¶Å
        run: |
          echo "## üìã Changelog ÁîüÊàêÊëòË¶Å" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ "${{ steps.changelog.outputs.changed }}" = "true" ]; then
            echo "‚úÖ **Áä∂ÊÄÅ**: Changelog Â∑≤Êõ¥Êñ∞Âπ∂Êèê‰∫§" >> $GITHUB_STEP_SUMMARY
            echo "üìÑ **Êñá‰ª∂**: CHANGELOG.md" >> $GITHUB_STEP_SUMMARY
            echo "üîó **Êèê‰∫§**: [Êü•ÁúãÊõ¥Êîπ](https://github.com/${{ github.repository }}/commit/${{ github.sha }})" >> $GITHUB_STEP_SUMMARY
          else
            echo "üìÑ **Áä∂ÊÄÅ**: Changelog Ê≤°ÊúâÊõ¥Êîπ" >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### üõ†Ô∏è Â∑•ÂÖ∑‰ø°ÊÅØ" >> $GITHUB_STEP_SUMMARY
          echo "- **Â∑•ÂÖ∑**: git-cliff" >> $GITHUB_STEP_SUMMARY
          echo "- **ÈÖçÁΩÆ**: cliff.toml" >> $GITHUB_STEP_SUMMARY
          echo "- **Ê†ºÂºè**: Keep a Changelog" >> $GITHUB_STEP_SUMMARY
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### üìù ÊâãÂä®‰ΩøÁî®" >> $GITHUB_STEP_SUMMARY
          echo '```bash' >> $GITHUB_STEP_SUMMARY
          echo '# ÁîüÊàêÂÆåÊï¥ changelog' >> $GITHUB_STEP_SUMMARY
          echo 'git-cliff --output CHANGELOG.md' >> $GITHUB_STEP_SUMMARY
          echo '' >> $GITHUB_STEP_SUMMARY
          echo '# ÁîüÊàêÊú™ÂèëÂ∏ÉÁöÑÊõ¥Êîπ' >> $GITHUB_STEP_SUMMARY
          echo 'git-cliff --unreleased --output CHANGELOG.md' >> $GITHUB_STEP_SUMMARY
          echo '' >> $GITHUB_STEP_SUMMARY
          echo '# ÁîüÊàêÂà∞ÁâπÂÆöÊ†áÁ≠æ' >> $GITHUB_STEP_SUMMARY
          echo 'git-cliff --tag v1.0.0 --output CHANGELOG.md' >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
