name: Ëá™Âä®ÁîüÊàê Changelog

on:
  push:
    tags:
      - "v*"
  workflow_dispatch:
    inputs:
      tag:
        description: "ÊåáÂÆöÊ†áÁ≠æ (ÂèØÈÄâ)"
        required: false
        type: string
      unreleased:
        description: "ÁîüÊàêÊú™ÂèëÂ∏ÉÁöÑÊõ¥Êîπ"
        required: false
        type: boolean
        default: false

jobs:
  generate-changelog:
    name: ÁîüÊàê Changelog
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write

    steps:
      - name: Ê£ÄÂá∫‰ª£Á†Å
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}
          ref: ${{ github.ref_name || 'main' }}

      - name: ÂÆâË£Ö git-cliff
        uses: taiki-e/install-action@v2
        with:
          tool: git-cliff

      - name: ÁîüÊàê Changelog
        id: changelog
        run: |
          echo "üîÑ ÁîüÊàê Changelog..."

          # Â§á‰ªΩÂéüÊñá‰ª∂
          cp CHANGELOG.md CHANGELOG.md.backup || true

          # Ê†πÊçÆËæìÂÖ•ÂèÇÊï∞ÊûÑÂª∫ÂëΩ‰ª§
          if [ "${{ github.event.inputs.unreleased }}" = "true" ]; then
            echo "üìù ÁîüÊàêÊú™ÂèëÂ∏ÉÁöÑÊõ¥Êîπ"
            git-cliff --unreleased --output CHANGELOG.md
          elif [ -n "${{ github.event.inputs.tag }}" ]; then
            echo "üè∑Ô∏è ÁîüÊàêÂà∞Ê†áÁ≠æ: ${{ github.event.inputs.tag }}"
            git-cliff --tag "${{ github.event.inputs.tag }}" --output CHANGELOG.md
          else
            echo "üìã ÁîüÊàêÂÆåÊï¥ changelog"
            git-cliff --output CHANGELOG.md
          fi

          # Ê£ÄÊü•ÊòØÂê¶ÊúâÊõ¥Êîπ
          if [ -f CHANGELOG.md.backup ] && cmp -s CHANGELOG.md CHANGELOG.md.backup; then
            echo "üìÑ Changelog Ê≤°ÊúâÊõ¥Êîπ"
            echo "changed=false" >> $GITHUB_OUTPUT
          else
            echo "‚úÖ Changelog Â∑≤Êõ¥Êñ∞"
            echo "changed=true" >> $GITHUB_OUTPUT

            # Ëé∑ÂèñÊñá‰ª∂‰ø°ÊÅØ
            if [ -f CHANGELOG.md ]; then
              FILE_SIZE=$(stat -c%s CHANGELOG.md)
              LINE_COUNT=$(wc -l < CHANGELOG.md)
              echo "üìä Êñá‰ª∂Â§ßÂ∞è: $FILE_SIZE Â≠óËäÇ"
              echo "üìè ÊÄªË°åÊï∞: $LINE_COUNT Ë°å"
            fi
          fi

          # Ê∏ÖÁêÜÂ§á‰ªΩÊñá‰ª∂
          rm -f CHANGELOG.md.backup

      - name: Êèê‰∫§ Changelog
        if: steps.changelog.outputs.changed == 'true'
        run: |
          echo "üìù Êèê‰∫§ Changelog Êõ¥Êîπ..."

          # ÈÖçÁΩÆ Git
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"

          # Ê∑ªÂä†Âπ∂Êèê‰∫§Êõ¥Êîπ
          git add CHANGELOG.md

          # Ê£ÄÊü•ÊòØÂê¶ÊúâÂÜÖÂÆπÈúÄË¶ÅÊèê‰∫§
          if git diff --staged --quiet; then
            echo "Ê≤°ÊúâÊõ¥ÊîπÈúÄË¶ÅÊèê‰∫§"
            exit 0
          fi

          # Êèê‰∫§Êõ¥Êîπ
          git commit -m "docs: Ëá™Âä®Êõ¥Êñ∞ Changelog [skip ci]"

          # Êé®ÈÄÅÊõ¥Êîπ
          git push

      - name: ËæìÂá∫ÊëòË¶Å
        run: |
          echo "## üìã Changelog ÁîüÊàêÊëòË¶Å" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ "${{ steps.changelog.outputs.changed }}" = "true" ]; then
            echo "‚úÖ **Áä∂ÊÄÅ**: Changelog Â∑≤Êõ¥Êñ∞Âπ∂Êèê‰∫§" >> $GITHUB_STEP_SUMMARY
            echo "üìÑ **Êñá‰ª∂**: CHANGELOG.md" >> $GITHUB_STEP_SUMMARY
            echo "üîó **Êèê‰∫§**: [Êü•ÁúãÊõ¥Êîπ](https://github.com/${{ github.repository }}/commit/${{ github.sha }})" >> $GITHUB_STEP_SUMMARY
          else
            echo "üìÑ **Áä∂ÊÄÅ**: Changelog Ê≤°ÊúâÊõ¥Êîπ" >> $GITHUB_STEP_SUMMARY
          fi

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### üõ†Ô∏è Â∑•ÂÖ∑‰ø°ÊÅØ" >> $GITHUB_STEP_SUMMARY
          echo "- **Â∑•ÂÖ∑**: git-cliff" >> $GITHUB_STEP_SUMMARY
          echo "- **ÈÖçÁΩÆ**: cliff.toml" >> $GITHUB_STEP_SUMMARY
          echo "- **Ê†ºÂºè**: Keep a Changelog" >> $GITHUB_STEP_SUMMARY

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### üìù ÊâãÂä®‰ΩøÁî®" >> $GITHUB_STEP_SUMMARY
          echo '```bash' >> $GITHUB_STEP_SUMMARY
          echo '# ÁîüÊàêÂÆåÊï¥ changelog' >> $GITHUB_STEP_SUMMARY
          echo 'git-cliff --output CHANGELOG.md' >> $GITHUB_STEP_SUMMARY
          echo '' >> $GITHUB_STEP_SUMMARY
          echo '# ÁîüÊàêÊú™ÂèëÂ∏ÉÁöÑÊõ¥Êîπ' >> $GITHUB_STEP_SUMMARY
          echo 'git-cliff --unreleased --output CHANGELOG.md' >> $GITHUB_STEP_SUMMARY
          echo '' >> $GITHUB_STEP_SUMMARY
          echo '# ÁîüÊàêÂà∞ÁâπÂÆöÊ†áÁ≠æ' >> $GITHUB_STEP_SUMMARY
          echo 'git-cliff --tag v1.0.0 --output CHANGELOG.md' >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
